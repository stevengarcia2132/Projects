---
title: "Homework 4"
subtitle: <center> <h1>Multiple Linear Regression</h1> </center>
author: <center> Steven Garcia <center>
output: html_document
---

<style type="text/css">
h1.title {
  font-size: 40px;
  text-align: center;
}
</style>

```{r setup, include=FALSE}
library(tidyverse)
library(ggfortify)  # plot lm objects using ggplot instead of base R
library(car)  # needed for added-variable plots and dfbetas and dffits
library(corrplot)  # colored correlation matrix
library(gridExtra) 

```

*Note that you do not need to properly format the axis limits in your plots for this assignment (to save time). You should, however, still make the plots square in shape.*

## Data and Description

Measuring body fat is not simple. One method requires submerging the body underwater in a tank and measuring the increase in water level. A simpler method for estimating body fat would be preferred. In order to develop such a method, researchers recorded age (years), weight (pounds), height (inches), and three body circumference measurements (around the neck, chest, and abdominal (all in centimeters)) for 252 men. Each manâ€™s percentage of body fat was accurately estimated by an underwater weighing technique (the variable brozek is the percentage of body fat). The hope is to be able to use this data to create a model that will accurately predict body fat percentage, by using just the basic variables recorded, without having to use the tank submerging method. 

The data can be found in the BodyFat data set on Canvas. Download "BodyFat.txt", and put it in the same folder as this R Markdown file.

#### 0. Replace the text "< PUT YOUR NAME HERE >" (above next to "author:") with your full name.

#### 1. Read in the data set, and call the data frame "bodyfat". Print a summary of the data and make sure the data makes sense. **Remove the "row" column (which contains row numbers) from the data set.**

```{r}
bodyfat <- read.table("Bodyfat.txt", header = TRUE)
bodyfat <- bodyfat[-1]
summary(bodyfat)
```

#### 2. Create and print a scatterplot matrix of the data.

```{r, fig.align='center'}
pairs(~brozek + age + weight + height + neck + chest + abdom,
       data = bodyfat)

```

#### 3. Based on the scatterplot matrix, briefly explain which variables you think will be "significant" for predicting brozek and which variables you think will *not* be helpful at predicting brozek. Explain how the scatterplot helped determine your answers.

I think abdomen and chest would be helpful in predicting 
brozek because there seems to be a strong positive linear association
among those variables. 

#### 4. Create and print a correlation matrix (numeric or color- and shape-coded).

```{r}
cor1 <- cor(bodyfat)

corrplot(cor1, method = "circle", type = "upper")
corrplot(cor1, method = "number", type = "upper")
```

#### 5. Based on the scatterplot matrix and the correlation matrix, are their any pairs of variables that you suspect will cause a problem for the multicollinearity assumption? If so, which ones?

The circles for abdomen and chest are the most similar
so I would assume out of all the variables these two would be the most
correlated which could cause an issue with multicollinearity. 

#### 6. Fit a multiple linear regression model to the data (no transformations). Print a summary of the results. Save the residuals to the `bodyfat` data frame.

```{r}
model <- lm(data = bodyfat, brozek ~. )
summary(model)
bodyfat$Residuals <- model$residuals

```

#### 7. Briefly comment on the "significance" of the variables: were you surprised by the results? Are there any variables that are significant that you think shouldn't be? Are there any variables that are not significant that you think should be?

Yeah I did not expect abdomen to have such a low pvalue level. I thought
chest would be significant in predicting brozek but it turns out its not
as helpful as weight or neck. However, weight and neck are fairly close to .05 compared to abdomen. So abdomen is much more helpful
in predicting weight or neck. 

#### 8. Briefly comment on the sign (+/-) of the coefficients for the variables. Are their any variables where the sign is the opposite of what you expected?

The signs for the weight, height, and neck were not expected. Those 
variables were positively correlated but have negative coefficients. Chest
and abdomen have positive coefficients which was expected. 

#### 9. Mathematically write out the *fitted* multiple linear regression model for this data set using the coefficients you found above (do not use betas). Do not use "X" and "Y" in your model - use variable names that are fairly descriptive.

$$\widehat{brozek}_i = -2.010^{01} + 5.010^{-03}\text{age}_i 
-8.733^{-02}\text{weight}_i -1.400^{-01}\text{height}_i 
-4.421^{-01}\text{neck}_i + 4.844^{-04}\text{chest}_i 
+ 8.754^{-01}\text{abdom}_i$$ 

#### 10. *Assuming* the model assumptions are all met, how would you interpret the coefficient for Weight?

Holding all else constant as weight increases the average
brozek score(percent of body fat score)decreases by $$-8.733^{-02}$$ pounds

#### 11. Briefly explain what it means to "hold all else constant" when interpreting a coefficient.

It means that other variables are unchanging so any change in the response(brozek) is a result of a change in the predictor that we're focusing on. 

#### 12. Briefly explain what the F-test indicates, as reported in the model output from question 6.

With a very small pvalue we have evidence that at least one coefficient 
significantly explains the average in brozek(body fat percentage).  

#### 13. Briefly interpret the *adjusted* R-squared, as reported in the model output from question 6.

71% of the total variation in rating can be explained by these predictors after accounting for the number of predictors in the model.

### Questions 14-20 involve using diagnostics to determine if the linear regression assumptions are met. For each assumption, (1) perform appropriate diagnostics to determine if the assumption is violated, and (2) explain whether or not you think the assumption is violated and why you think that.

#### 14. (L) The X's vs Y are linear (use the residual vs. predictor plots, partial regression plots, and one other diagnostic tool of your choice). 

```{r, fig.align='center'}

#residuals vs predictor plot
ageresid <- ggplot(data = bodyfat, mapping = aes(x = age, y = Residuals))+
  geom_point()+
  theme(aspect.ratio = 1)

weightresid <- ggplot(data = bodyfat, mapping = aes(x = weight, y = Residuals))+
  geom_point()+
  theme(aspect.ratio = 1)

heightresid <- ggplot(data = bodyfat, mapping = aes(x = height, y = Residuals))+
  geom_point()+
  theme(aspect.ratio = 1)

neckresid <- ggplot(data = bodyfat, mapping = aes(x = neck, y = Residuals))+
  geom_point()+
  theme(aspect.ratio = 1)

chestresid <- ggplot(data = bodyfat, mapping = aes(x = chest, y = Residuals))+
  geom_point()+
  theme(aspect.ratio = 1)

abdomresid <- ggplot(data = bodyfat, mapping = aes(x = abdom, y = Residuals))+
  geom_point()+
  theme(aspect.ratio = 1)

grid.arrange(ageresid,weightresid,heightresid,neckresid,chestresid,abdomresid,nrow=2)

```

```{r, fig.align='center'}
#partial regression plot
avPlots(model)
```

```{r, fig.align='center'}
#resid vs fitted values
residplot <- autoplot(model, which = 1, ncol = 1, nrow = 1)+
  theme(aspect.ratio = 1)
residplot
```

I think the linearity assumption is met because of the evidence in the
residual vs fitted values plot. There is curvature towards the right side 
of the chart but it isn't strong curvature. In the added variable plot the
chest, age, and height are all mostly horizontal which shows they're not skewed. Overall there is enough evidence to assume x and y are linear. 

#### 15. (I) The residuals are independent (no diagnostic tools - just think about how the data was collected and briefly write your thoughts)

From the data description it isn't stated that the data was randomly sampled so 
we cant say it was or wasn't. The men chosen could've been picked randomly
but it isn't stated that they were collected that way. 

#### 16. (N) The residuals are normally distributed and centered at zero (use all four diagnostic tools)

```{r, fig.align='center'}
# Diagnostic 1
shapiro.test(model$residuals)
```

```{r, fig.align='center'}
# Diagnostic 2
autoplot(model, which = 2, ncol = 1, nrow = 1) 

```

```{r, fig.align='center'}
# Diagnostic 3
boxplot(model$residuals)

```

```{r, fig.align='center'}
# Diagnostic 4
StopHist <- ggplot(data = bodyfat)+
  geom_histogram(mapping = aes(x = Residuals, y = ..density..),
  binwidth = 2) + 
  stat_function(fun = dnorm,
                color = "red",
                size = 2,
                args = list(mean = mean(bodyfat$Residuals),
                            sd = sd(bodyfat$Residuals)))+
  theme(aspect.ratio = 1)

StopHist
```

From these four tests we have strong evidence that the residuals are normally
distributed. The shapiro wilk test gives a high pvalue which says we fail
to reject the null hypothesis. The box plot also has equal length whiskers and 
both the boxplot and the histogram are both centered around zero. The normal
probability plot also shows that most of the points fall along the line giving
more evidence its normally distributed and centered at zero. 


#### 17. (E) The residuals have equal/constant variance across all values of X (only one diagnostic tool)

```{r, fig.align='center'}

residplot
```

From this one test you can see that the variance is spread out evenly for most of the
data. Towards the right the variance gets smaller as the points
come are closer together but overall you can say it 
has constant variance.

#### 18. (A) The model describes all observations (i.e., there are no influential points) (use Cook's distance, DFBETAS, and DFFITS. Also, in your response, refer to the evidence from the plots you created in previous questions)

```{r, fig.align='center'}
# Cook's Distance
bodyfat$cooksd <- cooks.distance(model)

ggplot(data = bodyfat) + 
  geom_point(mapping = aes(x = as.numeric(rownames(bodyfat)), 
                           y = cooksd), position = "jitter") +
  ylab("Cook's Distance") +
  xlab("Observation Number") +
  geom_hline(mapping = aes(yintercept = 4 / length(cooksd)),
             color = "red", 
             linetype = "dashed") +
  theme(aspect.ratio = 1)

bodyfat %>% 
  mutate(rowNum = row.names(bodyfat)) %>%  # save original row numbers 
  filter(cooksd > 4 / length(cooksd)) %>%  # select potential outliers
  arrange(desc(cooksd))  # order from largest Cook's distance to smallest

```

```{r, fig.align='center'}
# DFBETAS

bodyfat$dfbetas_distance <- as.vector(dfbetas(model)[, 2])

ggplot(data = bodyfat) + 
  geom_point(mapping = aes(x = as.numeric(rownames(bodyfat)), 
                           y = abs(dfbetas_distance))) +
  ylab("Absolute Value of DFBETAS for square root of Distance") +
  xlab("Observation Number") +
  # for n > 30
  geom_hline(mapping = aes(yintercept = 2 / sqrt(length(dfbetas_distance))),
             color = "red", 
             linetype = "dashed") + 

  theme(aspect.ratio = 1)

bodyfat %>% 
  mutate(rowNum = row.names(bodyfat)) %>%  # save original row numbers 
  filter(abs(dfbetas_distance) > 2 / 
           sqrt(length(rownames(bodyfat)))) %>%  # select potential influential pts
  arrange(desc(abs(dfbetas_distance)))  # order from largest DFBETAS to smallest


```

```{r, fig.align='center'}
# DFFITS

bodyfat$dffits <- dffits(model)

ggplot(data = bodyfat) + 
  geom_point(mapping = aes(x = as.numeric(rownames(bodyfat)), 
                           y = abs(dffits))) +
  ylab("Absolute Value of DFFITS for Y") +
  xlab("Observation Number") +
  # for n > 30
  geom_hline(mapping = aes(yintercept = 2 * sqrt(length(model$coefficients) /
                                                   length(dffits))),
             color = "red", 
             linetype = "dashed") +
  theme(aspect.ratio = 1)

bodyfat %>% 
  mutate(rowNum = row.names(bodyfat)) %>%  # save original row numbers 
  filter(abs(dffits) > 2 * sqrt(length(model$coefficients) / 
                                  length(dffits))) %>%
  arrange(desc(abs(dffits))) 

```

The model describes all observations assumption is not because in each of 
the three plots there is one influential point that shows up. It would be
best to take out that point and see if it really is influential and affecting the model. 

#### 19. (R) Additional predictor variables are not required (no diagnostic tools - just think about the variables you have and if there are other variables you think would help predict the response)


I think this assumption is met because there are already a lot of predictor variables in the model. A few of these predictors aren't useful such as age or weight

#### 20. No multicollinearity (for this assumption, compute the variance inflation factors (VIFs) and compare the VIFs to your comments in questions 5. Do the variance inflation factors match your assumptions from questions 5? Is this assumption met?

```{r, fig.align='center'}

vif(model)
mean(vif(model))
```

This assumption is not met because a few predictors like abdomen and weight have very high VIFs. These two are much higher than 10 so they are correlated and the mean VIF is also much higher than one because of these two. 

### Note: your next homework assigment will use this same data set, and you will be asked to fix the assumptions that were broken.

#### 21. Briefly summarize what you learned, personally, from this analysis about the statistics, model fitting process, etc.

I learned how to interpret correlation matrixes and added variable plots. I also learned how correlation values and pvalues don't always have the same sign a linear regression test is performed on it. 

#### 22. Briefly summarize what you learned from this analysis *to a non-statistician*. Write a few sentences about (1) the purpose of this data set and analysis and (2) what you learned about this data set from your analysis. Write your response as if you were addressing a business manager (avoid using statistics jargon) and just provide the main take-aways.

The purpose of this data set was to analyze the relationship between age, weight, height, neck, chest, and abdomen with body fat percentage. Knowing the relationship between these two can help researchers predict body fat percentage without having to use an expensive process. From the data we learn that abdomen seems to be very effective in predicting bodyfat.

